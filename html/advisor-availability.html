<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disponibilidad | Asesor UNAM</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    
    <!-- Header -->
    <header class="main-header">
        <div class="header-left">
            <div class="brand-logo" onclick="window.location.href='index.html'" style="cursor: pointer;">
                <img src="../img/logo.png" alt="UNAM" style="height: 45px; width: auto; margin-right: 8px;">
                <span>UNAM</span>
            </div>
            <div class="app-version">
                <span>Panel de Asesor</span>
            </div>
        </div>
        <div class="header-right">
            <div class="user-nav">
                <span id="header-user-name">Asesor</span>
                <i class="ri-account-circle-line"></i>
                <i class="ri-logout-box-r-line" id="btn-logout" title="Cerrar Sesión"></i>
            </div>
        </div>
    </header>

    <div class="app-body">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <a href="advisor-availability.html" class="nav-item active">
                <i class="ri-calendar-check-line"></i>
                <span>Disponibilidad</span>
            </a>
            <a href="advisor-requests.html" class="nav-item">
                <i class="ri-file-text-line"></i>
                <span>Solicitudes / Cartas</span>
            </a>
            <a href="advisor-kanban.html" class="nav-item">
                <i class="ri-artboard-line"></i>
                <span>Tablero / Avance</span>
            </a>
            <a href="chat.html" class="nav-item">
                <i class="ri-chat-1-line"></i>
                <span>Mensajes</span>
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="welcome-card" style="border-top-color: #00897b;">
                <div class="welcome-text">
                    <h2 style="color: #00897b;">Gestión de Disponibilidad</h2>
                    <p>Configura tu estado para recibir nuevas solicitudes de asesoría.</p>
                </div>
            </div>

            <!-- Availability Card -->
            <div class="card" style="max-width: 600px; margin: 20px auto 60px auto; text-align: center; padding: 40px 40px 60px 40px;">
                <div style="margin-bottom: 20px;">
                   <div id="status-icon-container" style="display: inline-flex; align-items: center; justify-content: center; width: 100px; height: 100px; border-radius: 50%; background: #e0f2f1; margin-bottom: 20px;">
                       <i class="ri-user-follow-line" id="status-icon" style="font-size: 3rem; color: #00695c;"></i>
                   </div>
                </div>
                
                <h3 id="current-status-title" style="font-size: 1.5rem; margin-bottom: 10px;">Disponible</h3>
                <p id="current-status-desc" style="color: #666; margin-bottom: 30px;">
                    Actualmente estás aceptando nuevas solicitudes de asesoría. Los estudiantes pueden enviarte propuestas.
                </p>

                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px;">
                    <span style="font-size: 0.9rem; font-weight: 500; color: #666;">No Disponible</span>
                    
                    <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                        <input type="checkbox" id="status-toggle">
                        <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                        <style>
                            .slider:before {
                                position: absolute;
                                content: "";
                                height: 26px;
                                width: 26px;
                                left: 4px;
                                bottom: 4px;
                                background-color: white;
                                transition: .4s;
                                border-radius: 50%;
                            }
                            input:checked + .slider {
                                background-color: #2e7d32;
                            }
                            input:focus + .slider {
                                box-shadow: 0 0 1px #2e7d32;
                            }
                            input:checked + .slider:before {
                                transform: translateX(26px);
                            }
                        </style>
                    </label>
                    
                    <span style="font-size: 0.9rem; font-weight: 500; color: #2e7d32; font-weight: bold;">Disponible</span>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        // Simple Auth Check
        const currentUser = JSON.parse(localStorage.getItem('nexus_current_user'));
        if(!currentUser) {
            window.location.href = 'login.html';
        } else {
             document.getElementById('header-user-name').textContent = currentUser.name;
        }

        document.getElementById('btn-logout').addEventListener('click', () => {
             localStorage.removeItem('nexus_current_user');
             window.location.href = 'login.html';
        });

        // Availability Logic
        const advisors = JSON.parse(localStorage.getItem('nexus_advisors')) || [];
        const myProfileIndex = advisors.findIndex(a => a.user === currentUser.user);
        let myProfile = myProfileIndex !== -1 ? advisors[myProfileIndex] : {};

        const toggleInput = document.getElementById('status-toggle');
        const statusTitle = document.getElementById('current-status-title');
        const statusDesc = document.getElementById('current-status-desc');
        const statusIcon = document.getElementById('status-icon');
        const iconContainer = document.getElementById('status-icon-container');

        function updateUI() {
             if(myProfile.status === 'active') {
                 statusTitle.textContent = "Disponible";
                 statusTitle.style.color = "#2e7d32";
                 statusDesc.textContent = "Actualmente estás aceptando nuevas solicitudes de asesoría. Los estudiantes pueden enviarte propuestas.";
                 
                 iconContainer.style.background = "#e8f5e9";
                 statusIcon.className = "ri-check-line";
                 statusIcon.style.color = "#2e7d32";
                 
                 toggleInput.checked = true;
             } else {
                 statusTitle.textContent = "No Disponible";
                 statusTitle.style.color = "#c62828";
                 statusDesc.textContent = "No estás aceptando nuevas solicitudes por el momento. Tu perfil no aparecerá en la lista de selección.";
                 
                 iconContainer.style.background = "#ffebee";
                 statusIcon.className = "ri-prohibited-line";
                 statusIcon.style.color = "#c62828";

                 toggleInput.checked = false;
             }
        }

        // Initialize status if undefined
        if(!myProfile.status) {
            myProfile.status = 'active'; 
            if(myProfileIndex !== -1) {
                advisors[myProfileIndex].status = 'active';
                localStorage.setItem('nexus_advisors', JSON.stringify(advisors));
            }
        }
        
        updateUI();

        // Check for Active Designations to Lock Availability
        function checkActiveLocks() {
            const allRequests = JSON.parse(localStorage.getItem('nexus_requests')) || [];
            // Find if I have any active Designations
            const activeDesignation = allRequests.find(r => 
                r.type === 'Designación de Asesor' && 
                r.status === 'approved' &&
                r.designation && (r.designation.advisorId === currentUser.user || r.designation.advisorId === currentUser.id)
            );

            if(activeDesignation) {
                // Lock the UI
                toggleInput.disabled = true;
                
                // Add visual feedback
                const container = document.querySelector('.card');
                const existingWarning = document.getElementById('lock-warning');
                if(!existingWarning) {
                    const warning = document.createElement('div');
                    warning.id = 'lock-warning';
                    warning.style.marginTop = '20px';
                    warning.style.padding = '10px';
                    warning.style.background = '#fff3e0';
                    warning.style.border = '1px solid #ffb74d';
                    warning.style.color = '#e65100';
                    warning.style.borderRadius = '8px';
                    warning.style.fontSize = '0.9rem';
                    warning.innerHTML = `<i class="ri-lock-2-line"></i> <strong>Estado Bloqueado:</strong> Tienes designaciones de tesis en curso (${activeDesignation.studentName}). No puedes cambiar tu disponibilidad hasta que finalice el proceso.`;
                    container.appendChild(warning);
                }
            }
        }

        checkActiveLocks();

        toggleInput.addEventListener('change', () => {
             // Toggle
             myProfile.status = toggleInput.checked ? 'active' : 'inactive';
             
             // Save
             if(myProfileIndex !== -1) {
                 advisors[myProfileIndex] = myProfile;
                 localStorage.setItem('nexus_advisors', JSON.stringify(advisors));
             }

             // Animate UI
             updateUI();
        });

    </script>
</body>
</html>

